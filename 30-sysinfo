#!/bin/bash

# Color file to have color aliases
source /etc/update-motd.d/colors

# To test with custom color
if [ -z "$1" ]; then
	COLOR=$GREEN
else
	COLOR=$1
fi

# OS version
if [ -f /etc/os-release ]; then
	source /etc/os-release
	os_version=$PRETTY_NAME
else
	os_version="Unknown OS"
fi

# Model
model=`cat /proc/cpuinfo | grep -i "^Model" | awk -F": " '{print $2}'`

# IP adress
ipaddr=`hostname -I | cut -d " " -f1`

# Date
date=`date +"%a %b %d %Y, %I:%M:%S %p"`

# Number of cores
cores=`nproc`

# Load average
read one five fifteen rest < /proc/loadavg

# RAM memory
mem_available=$((`cat /proc/meminfo | grep MemAvailable | awk {'print $2'}`/1024))
mem_total=$((`cat /proc/meminfo | grep MemTotal | awk {'print $2'}`/1024))
mem_pourcent_free=$((($mem_available * 100)/$mem_total))

# SWAP memory
swap_available=$((`cat /proc/meminfo | grep SwapFree | awk {'print $2'}`/1024))
swap_total=$((`cat /proc/meminfo | grep SwapTotal | awk {'print $2'}`/1024))
swap_pourcent_free=$((($swap_available * 100)/$swap_total))

# Temperature
if [ -x "$(command -v vcgencmd)" ]; then # Under raspberrypi
	temp="`vcgencmd measure_temp | cut -c "6-9"`°C"
else
	temp=`paste <(cat /sys/class/thermal/thermal_zone*/type) <(cat /sys/class/thermal/thermal_zone*/temp) | column -s $'\t' -t | sed 's/\(.\)..$/.\1°C/'`
fi

# Number of processes
processes=`ls -d /proc/[0-9]* | wc -l`

# Current connected users in SSH or console
current_users=`who`

# Server uptime
uptime=`uptime -p`

# Disk usage (use 2s timeout for weak nfs mounts)
disk_usage=`timeout --signal=kill 2s df -h ~ | grep -E "^(/dev/|Filesystem)"`




# Displaying
echo "$model - $os_version"
echo ""
echo -e "${COLOR}Processors       »${OFF} $cores cores"
echo -e "${COLOR}Processor load   »${OFF} $one (1min) - $five (5min) - $fifteen (15min)"
echo -e "${COLOR}Memory available »${OFF} $mem_available MB / $mem_total MB ($mem_pourcent_free% free)"
echo -e "${COLOR}Swap available   »${OFF} $swap_available MB / $swap_total MB ($swap_pourcent_free% free)" 

echo -e "${COLOR}Temperature      »${OFF} $temp"
echo -e "${COLOR}All processes    »${OFF} $processes"
echo -e "${COLOR}IP adress        »${OFF} $ipaddr"
echo -e "${COLOR}Uptime           »${OFF} $uptime"
echo ""
echo -e "${COLOR}Disk usage       »${OFF}"
echo -e "$disk_usage"
echo ""
echo -e "${COLOR}Current users    »${OFF}"
echo -e "$current_users"